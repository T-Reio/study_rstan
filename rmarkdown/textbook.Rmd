---
title: "Studying R Stan"
author: "R. Tanji"
date: ""
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(pacman)
library(tidyverse)
```

## Chap 1 統計モデリングとStanの概要

### 統計モデリングとは

-   世の中の事象を、必要なエッセンスだけ取り出して描写すること

    -   プラモデル：色や形を残して材質・機能を捨象

-   数式を用いてエッセンスを記述する：数理モデル

    -   確率モデル probabilistic model

-   統計モデリング：確率モデルをデータに当てはめて、現象の理解と予測を促す

    -   統計モデリングの要素

        -   確率分布

        -   パラメータ

        -   パラメータをつなぐ関係式

-   モデル化にあたって捨象した要素の重要性を確認する

### 統計モデリングの目的

統計モデルの2つの目的

-   解釈

    -   データの生成過程を理解する

    -   解釈可能なモデルをもとに、次のアクションを決める

-   予測

**頑健性**：解釈可能で予測精度の高いモデル

-   機械学習との違い：SVM: サポートベクターマシン、勾配ブースティング、ランダムフォレスト、...

    -   数式をモデリングするための背景知識が少なくても予測可能

    -   過学習が起こりやすい

-   古典的な分散分析、グループごとの集計との違い

    -   直感的で解釈しやすい

    -   対象に対する背景知識や経験を活用しきれない

→両者の性能を併せ持つ手法としての統計モデリング

### 確率的プログラミング言語

-   確率モデルのパラメータ推定における難点

    -   推定計算の数式導出

    -   モデルの変化に対応した数値計算の実装

-   プログラミング言語の登場により、これらの操作がより平易に

    -   多数のモデルを試行錯誤可能に

### なぜStanなのか

-   これまで主流だったソフトウェア

    -   WinBUGS

    -   JAGS

-   **Stan**

    -   RStan

    -   PythonやMATLABとも連携可能

    -   **NUTS**: No-U-Turn Sampler

        -   Hamiltonian Monte Carlo (HMC, MCMCの一種)の実装

        -   パラメータの数が多い場合の効率的なサンプリング

        -   1ステップあたりの所要時間はその他の言語に比べて長いが、ステップ間の相関が低いため、従来よりも少ないステップで計算を完了することができる

        -   複雑なモデルのサンプリングも可能

    -   その他、デバッグのしやすさ、マニュアルの詳細さなどの長所

### なぜRStanなのか

-   Stanの性能とRの優れた可視化機能を連結

-   確率分布を使うモデルが容易に実装可能

-   データ加工も容易

## Chap2 ベイズ推定の復習

### 基本用語と記法

-   確率分布

-   確率質量関数

-   確率密度関数

-   同時分布

-   周辺化と周辺分布

-   条件付確率分布

-   $y \sim p(y)$

-   正規化

-   偏微分

-   大文字から始まるアルファベット

-   ベクトルと行列

-   添え字と[]

### 伝統的な統計学(頻度論)の問題点

### 尤度と最尤推定

### ベイズ推定とMCMC

### ベイズ信頼区間とベイズ予測区間

### 最尤推定とベイズ推定との関係

### 事前分布の選択

## Chap 3

### データ解析の前準備

### 統計モデリングの手順

### モデルの記述方法

### 情報量基準を使ったモデル選択

## Chap 4 StanとRStanをはじめよう

### StanとRStanの準備

-   Rtoolsのインストール

    -   内部でC++を利用、そのコンパイラが必要になる

    -   PATH通しとく

-   起動

    ```{r}
    #install.packages("rstan")
    p_load(rstan)
    ```

### Stanの基本的な文法

以降、chap3.stanも参照してくれ

#### 文法の基礎

```{stan, output.var="hoge", eval=FALSE}
data {
  データYの宣言
}

parameters {
  サンプリングしたいパラメータ\thetaの宣言
}

model {
  尤度関数p(Y|\theta)の記述
  事前分布p(\theta)の記述
}
```

#### 文法の基礎

-   標準偏差の定まった：正規分布をデータに当てはめる問題

-   モデル式4-1

$$
\begin{align}
Y[n] & \sim \text{Normal}(\mu, 1) \text{ where } n = 1, \ldots, N \\
\mu & \sim \text{Normal}(0, 100)
\end{align}
$$
- $N$は観測数に対応